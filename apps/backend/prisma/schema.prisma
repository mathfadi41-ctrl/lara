generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Stream {
  id               String       @id @default(cuid())
  name             String
  rtspUrl          String
  status           StreamStatus @default(STOPPED)
  type             StreamType   @default(COLOR)
  splitLayout      SplitLayout?
  detectionEnabled Boolean      @default(true)
  fps              Int          @default(5)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  lastHeartbeat    DateTime?
  lastFrameAt      DateTime?
  avgLatencyMs     Float        @default(0)
  detections       Detection[]

  @@index([status])
  @@map("streams")
}

model Detection {
  id            String        @id @default(cuid())
  streamId      String
  stream        Stream        @relation(fields: [streamId], references: [id], onDelete: Cascade)
  timestamp     DateTime      @default(now())
  confidence    Float
  label         String
  detectionType DetectionType @default(SMOKE)
  boundingBox   Json
  imagePath     String
  metadata      Json?
  createdAt     DateTime      @default(now())

  @@index([streamId, timestamp])
  @@index([timestamp])
  @@map("detections")
}

enum StreamStatus {
  STOPPED
  STARTING
  RUNNING
  ERROR
  STOPPING
}

enum StreamType {
  COLOR
  THERMAL
  SPLIT
}

enum SplitLayout {
  LEFT_RIGHT
  TOP_BOTTOM
}

enum DetectionType {
  SMOKE
  FIRE
  HOTSPOT
}
