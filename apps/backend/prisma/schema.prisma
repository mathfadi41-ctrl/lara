generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String          @id @default(cuid())
  email         String          @unique
  passwordHash  String
  role          Role            @default(Viewer)
  refreshTokens RefreshToken[]
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@map("users")
}

model RefreshToken {
  id        String    @id
  tokenHash String    @unique
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime  @default(now())

  @@index([userId])
  @@map("refresh_tokens")
}

enum Role {
  Admin
  Operator
  Viewer
}

model Stream {
  id               String       @id @default(cuid())
  name             String
  rtspUrl          String
  status           StreamStatus @default(STOPPED)
  type             StreamType   @default(COLOR)
  splitLayout      SplitLayout?
  detectionEnabled Boolean      @default(true)
  fps              Int          @default(5)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  lastHeartbeat    DateTime?
  lastFrameAt      DateTime?
  avgLatencyMs     Float        @default(0)
  detections       Detection[]
  telemetry        Telemetry[]

  @@index([status])
  @@map("streams")
}

model Detection {
  id              String        @id @default(cuid())
  streamId        String
  stream          Stream        @relation(fields: [streamId], references: [id], onDelete: Cascade)
  timestamp       DateTime      @default(now())
  confidence      Float
  label           String
  detectionType   DetectionType @default(SMOKE)
  boundingBox     Json
  imagePath       String
  screenshotKey   String?
  frameReference  String?
  metadata        Json?
  createdAt       DateTime      @default(now())

  @@index([streamId, timestamp])
  @@index([timestamp])
  @@map("detections")
}

model Telemetry {
  id        String          @id @default(cuid())
  streamId  String
  stream    Stream          @relation(fields: [streamId], references: [id], onDelete: Cascade)
  latitude  Float
  longitude Float
  altitude  Float
  heading   Float
  speed     Float
  roll      Float
  pitch     Float
  yaw       Float
  source    TelemetrySource @default(SIMULATOR)
  createdAt DateTime        @default(now())

  @@index([streamId, createdAt(sort: Desc)])
  @@map("telemetry")
}

enum StreamStatus {
  STOPPED
  STARTING
  RUNNING
  ERROR
  STOPPING
}

enum StreamType {
  COLOR
  THERMAL
  SPLIT
}

enum SplitLayout {
  LEFT_RIGHT
  TOP_BOTTOM
}

enum DetectionType {
  SMOKE
  FIRE
  HOTSPOT
}

enum TelemetrySource {
  MAVLINK
  SIMULATOR
  MANUAL
}
